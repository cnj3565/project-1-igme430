<!DOCTYPE html>
<html lang="en">
<head>
    <title>Project 1 - Carter Jensen - IGME 430</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <script>
      let taskNumber;
      
      const handleResponse = async (response, parseResponse) => {
      const content = document.querySelector('#content');
      
      switch(response.status) {
        case 200:
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201:
          content.innerHTML = '<b>Created User</b>';
          break;
        case 204:
          content.innerHTML = '<b>Updated Age</b>';
          return;
        case 400:
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 401:
          content.innerHTML = `<b>Unauthorized</b>`;
          break;
        case 404:
          content.innerHTML = '<b>Not Found</b>';
          break;
        default: 
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }
      
      // where the user info gets returned
      // will have to be expanded to fit project scope
      if(parseResponse) {
        const resText = await response.text();
        content.innerHTML += `<p>${resText}</p>`;
      } else {
        content.innerHTML += `<p>Meta Data Received</p>`;
      };
    };

    // Sends the user info, will be called in addUser
    const sendPost = async (nameForm) => {
      const nameAction = nameForm.getAttribute('action');
      const nameMethod = nameForm.getAttribute('method');
      
      const nameField = nameForm.querySelector('#nameField').value;
      const pwField = nameForm.querySelector('#pwField').value;

      // task info
      // create a loop which forms the string formData
      // using each part of the tasks, using the container
      // to select all at once
      
      const tasks = document.querySelector('#tasks');
      let taskArray = tasks.querySelectorAll('input');
      console.log(taskArray);

      // putting it together into JSON
      let taskNum = 1;
      let formData = `name=${nameField}&password=${pwField}&`;

      // looping through task list data
      for(let t = 0; t < taskArray.length-2; t+=2) {
        formData += `task${taskNum}=${taskArray[t].value}&`;
        formData += `deadline${taskNum}=${taskArray[t+1].value}&`;
        taskNum++;
      };

      // last task element
      if(taskArray.length > 2){
        formData += `task${taskNum}=${taskArray[taskArray.length-2].value}&`;
        formData += `deadline${taskNum}=${taskArray[taskArray.length-1].value}`;
      }

      let response = await fetch(nameAction, {
        method: nameMethod,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'Accept': 'application/json',
        },
        body: formData,
      });
      handleResponse(response);
    };

    // Returns user info, will be called in getUsers
    const requestUpdate = async (userForm, nameForm) => {
      
      let url = userForm.querySelector('#urlField').value;
      const method = userForm.querySelector('#methodSelect').value;

      const nameField = nameForm.querySelector('#nameField').value;
      const pwField = nameForm.querySelector('#pwField').value;

      url += "?" + `username=${nameField}&password=${pwField}`;

      
      let response = await fetch(url, {
        method,
        headers: { 
          'Accept': 'application/json',
        },
      });
      handleResponse(response, method === 'get');
    };

    // Adds new task row to task list
    const addNewTask = () => {
      taskNumber++;
      console.log("addTask called!");
      console.log(`Task number is ${taskNumber}`);
      const taskField = document.querySelector('#tasks');

      // Creates the label
      let newTaskLabel = document.createElement("label");
      newTaskLabel.for = `task${taskNumber}`;
      const labelText = document.createTextNode(`Task #${taskNumber}: `);
      newTaskLabel.appendChild(labelText);
      taskField.appendChild(newTaskLabel);

      // Creates the text field
      let newTaskField = document.createElement("input");
      newTaskField.type = "text";
      newTaskField.id = `task${taskNumber}Field`;
      newTaskField.name = `task${taskNumber}`;
      taskField.appendChild(newTaskField);

      // Creates the Due By label
      let deadline = document.createElement("label");
      deadline.for = `dl${taskNumber}`;
      const deadlineText = document.createTextNode(" Due By: ");
      deadline.appendChild(deadlineText);
      taskField.appendChild(deadline);

      // Creates Due By field
      let deadlineField = document.createElement("input");
      deadlineField.type = "text";
      deadlineField.id = `dl${taskNumber}Field`;
      deadlineField.name = `deadline${taskNumber}`;
      taskField.appendChild(deadlineField);
      taskField.appendChild(document.createElement("br"));
    }

    // Basic init function
    const init = () => {
      taskNumber = 1;
      
      const nameForm = document.querySelector('#nameForm');
      const userForm = document.querySelector('#userForm');
      const addTaskButton = document.querySelector('#addTaskButton');
      
      const addUser = (e) => {
        e.preventDefault();
        sendPost(nameForm);
        return false;
      };

      const getUsers = (e) => {
        e.preventDefault();
        requestUpdate(userForm, nameForm);
        return false;
      };
      
      nameForm.addEventListener('submit', addUser);
      userForm.addEventListener('submit', getUsers);
      addTaskButton.addEventListener("click", addNewTask);
    };

    //When the window loads, run init.
    window.onload = init;
    </script>
</head>

<body>
    <header>
      <h1>Your Very Own Task List</h1>
      <h3>Project 1 for IGME 430</h3>
    </header>
    <div id="main">
    <section id="top">
      <div id="instructions">
        <p>Fill in a Username and Password first, then add tasks in the task list</p>
        <p>Once you're finished, click the Add User button to add your list to the system.</p>
        <p>If you want to update your list, make sure your Username and Password is the same, and click Add User again.</p>
        <p>If you want to retrieve you list, fill in your Username and Password and click Get My List.</p>
      </div>

      <form id="nameForm" action="/addUser" method="post">
        <label for="name">Username: </label>
        <input id="nameField" type="text" name="name" />
        <label for="password">Password: </label>
        <input id="pwField" type="text" name="password" /><br>
        <input id="addUserButton" type="submit" value="Add User" />
      </form>
      <form id="userForm" action="/getUsers" method="get">
        <input id="getUserButton" type="submit" value="Get My List" />
      </form>
    </section>
    <section id="content">
      <container id="tasks">
        <h1>Task List</h1>
          <label for="task1">Task #1: </label>
          <input id="task1Field" type="text" name="task1" />
          <label for="dl1">Due By: </label>
          <input id="dl1Field" type="text" name="deadline1" /> <br>
      </container>
      <button id="addTaskButton" type="button">Add Task</button>
    </section>
    </div>
    <footer>Carter Jensen - Fall 2022 - IGME 430</footer>
</body>